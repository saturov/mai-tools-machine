# ADR-2026-02-22: YouTube downloader quality policy до 720p и cookies retry

## Статус
Принято (2026-02-22)

## Контекст
Сценарий `youtube.download` стабильно скачивал в низком качестве и не давал предсказуемого поведения для `720p` с ограничениями YouTube (age/login/challenge), где часто требуются браузерные cookies.

## Решение
1. Обновлен формат-селектор `youtube-downloader`:
   - целевой профиль ограничен `<=720p`;
   - для `strict` сначала выбирается диапазон `>=min_height` и `<=720`.
2. Добавлен предсказуемый порядок попыток:
   - сначала без cookies;
   - затем retry с cookies браузеров (`chrome` -> `safari` -> `firefox`, если не задан явный браузер).
3. При недоступности `strict`-цели выполняется автоматический downgrade в `best_effort` с явной диагностикой причины.
4. Логи дополнены тех. полями по попыткам и выбору формата (`client`, `auth`, `height`, `format`) без вывода секретов cookies/токенов.

## Рассмотренные альтернативы
1. Всегда использовать cookies в первой попытке.
   - Отклонено: лишняя зависимость от браузерного профиля и более высокий шанс platform-specific ошибок.
2. Оставить поведение "strict = fail" без автодеградации.
   - Отклонено: не соответствует целевому UX "скачать лучшее доступное до 720p".

## Последствия
Плюсы:
- Повышена вероятность получения `720p`, когда это возможно.
- При отсутствии `720p` шаг остается успешным за счет controlled fallback.
- Улучшена наблюдаемость причин деградации качества.

Минусы:
- Увеличивается число попыток скачивания в сложных кейсах.
- Больше диагностических строк в stderr.

## Затронутые файлы
- `tools/youtube-downloader/youtube_downloader.py`
- `tools/youtube-downloader/tests/test_quality_policy.py`
- `README.md`
