# AGENTS.md

## Purpose
Единая инструкция для агентов в корне `mai-tools-sandbox`: быстрый и безопасный workflow для "вайбкодинга" без потери качества. Здесь фиксируются практики, которые помогают держать в порядке реестр инструментов/skills (манифесты, кэш, резолв), минимизировать побочные эффекты и изменения вне задачи, а также синхронизировать документацию с фактическим поведением пайплайна.

## Project Scope
- Репозиторий: песочница утилит, схем и шаблонов для агентных workflow.
- Основные директории:
  - `config/` — конфигурации окружения/агента.
  - `docs/` — архитектура и дизайн-заметки.
  - `schemas/` — JSON-схемы контрактов.
  - `skills/` — локальные навыки и их реализация.
  - `templates/` — шаблоны/заготовки.
  - `tg-scraper/` — вложенный подпроект с собственной областью ответственности.
  - `tools/` — актуальные утилиты.
  - `scripts/` — скрипты сборки/резолва реестра (Ruby).
  - `state/` — кэш и артефакты состояния (например, `registry-cache.json`).
- Вложенные подпроекты могут иметь собственные `AGENTS.md` (например, `tg-scraper/`) — они приоритетнее в своей директории.

## Default Working Style
- Делай минимальные, точечные изменения под задачу.
- Сначала рабочий результат, затем аккуратный рефакторинг только если реально нужен.
- Не трогай не относящиеся к задаче файлы и поведение.
- При неясности предпочитай текущее поведение проекта, а не "идеальную" перестройку.

## Request Handling Policy
- Разрешено обрабатывать запросы напрямую (по коду/документации) без обязательного запуска `scripts/dispatch.rb`.
- `make dispatch` остается рекомендуемым инструментом для задач, которые естественно ложатся на capability/workflow-пайплайн.
- Для side-effect задач обязательно явно фиксировать, что именно будет выполнено, и запускать только релевантные шаги в рамках запроса.
- Для каждого запроса агент обязан добавлять в контекст актуальный `AGENTS.md` для текущей области работы (в корне: [AGENTS.md](AGENTS.md); во вложенных подпроектах — их локальный `AGENTS.md`, если он есть).

## Canonical Commands
- Показать доступные цели: `make help`
- Проверить манифесты: `make validate-manifests`
- Собрать кэш реестра: `make registry`
- Разрешить capability: `make resolve CAP=domain.action`
- Запустить unit-тесты реестра: `make test-registry`

## Change Policy
- Для проектирования задачи по добавлению новой утилиты использовать шаблон: [schemas/prd-task-template.md](schemas/prd-task-template.md).
- Для изменений в `tools/*/tool.yaml` обязательно прогонять:
  1. `make validate-manifests`
  2. `make registry`
  3. (по необходимости) `make resolve CAP=...`
- Для изменений в `scripts/tool_registry.rb` запускать `make test-registry`.
- Не менять формат `state/registry-cache.json` вручную, если это не отдельная явная задача.

## Code and Docs Conventions
- Следовать текущему стилю файлов; не вводить новые фреймворки/структуры без запроса.
- Не переименовывать публичные capability/action без причины и миграционного шага.
- Если меняется поведение реестра/роутинга, обновлять `docs/skills-ecosystem-architecture.md` в той же задаче.
- Любое изменение системы обязательно фиксировать в документации через ADR (например, в `docs/adr/`).
- Примеры команд в документации должны быть исполнимыми и актуальными.

## Logging ADR
- Актуальная архитектура логгирования агента: `docs/adr/2026-02-23-agent-logging-architecture.md`.

## Safety Rules
- Не выполнять деструктивные git-команды (`reset --hard`, принудительные checkout) без явного запроса.
- Не коммитить секреты, токены и локальные служебные артефакты.
- Учитывать, что рабочее дерево может быть "грязным": не откатывать чужие изменения.

## Debug Policy
- При проблемах с дебагом обязательно запускать проблемную команду в рамках своей рабочей сессии и смотреть фактический output.
- Обязательно изучать логи и ошибки до выдвижения гипотез; не ограничиваться чтением кода без воспроизведения.
- После каждой гипотезы запускать команду повторно и проверять результат на реальном поведении системы.
- Повторять цикл "запуск -> анализ логов/ошибок -> гипотеза -> правка -> повторный запуск" до тех пор, пока проблема не устранена и система не ведет себя ожидаемым образом.

## Agent Checklist Before Finalizing
1. Изменения решают именно поставленную задачу и не расширяют scope.
2. Нужные `make`-проверки выполнены и результат зафиксирован в отчёте.
3. Документация синхронизирована с кодом (если поведение менялось).
4. В финальном ответе кратко: что сделано, какие проверки запущены, что осталось на усмотрение пользователя.
